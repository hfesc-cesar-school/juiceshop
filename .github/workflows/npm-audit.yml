name: NPM Audit

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  audit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: Instalar dependÃªncias
        run: |
          if [ -f package-lock.json ]; then
            echo "ğŸš€ package-lock.json encontrado, usando npm ci"
            npm ci
          else
            echo "ğŸ”§ package-lock.json nÃ£o encontrado, usando npm install"
            npm install
          fi

      - name: Executar npm audit
        # '--json' envia output para STDOUT, '|| true' impede exit code â‰  0 de abortar
        run: npm audit --json > audit-report.json || true

      - name: Instalar jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Validar resultados do audit
        run: |
          total=$(jq '   \
            if .metadata.vulnerabilities then    \
              reduce .metadata.vulnerabilities[] as $v (0; . + $v)    \
            else 0 end' audit-report.json)

          if [ "$total" -eq 0 ]; then
            echo "âœ… Nenhuma vulnerabilidade encontrada pelo npm audit"
          else
            echo "âŒ npm audit encontrou $total vulnerabilidades:"
            jq -r '.advisories[]
                    | "\(.severity) em \(.module_name) â€“ \(.title):
    versÃµes vulnerÃ¡veis: \(.vulnerable_versions);
    patch em: \(.patched_versions);
    mais info: \(.url)"' \
      audit-report.json
      exit 1
      fi
